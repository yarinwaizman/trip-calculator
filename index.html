<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8">
  <title>מחשבון נסיעות</title>
  <style>
    body { font-family: sans-serif; direction: rtl; padding: 20px; }
    label, input, select { display: block; margin-bottom: 10px; }
    h3 { margin-top: 20px; }
    input[type="text"] { direction: rtl; }
  </style>
</head>
<body>
  <h2>חישוב נסיעה</h2>

  <label>סוג נסיעה:</label>
  <select id="tripType" onchange="toggleReturn()">
    <option value="oneway">הלוך</option>
    <option value="roundtrip">הלוך וחזור</option>
  </select>

  <h3>נסיעה הלוך</h3>
  <label>מוצא:</label>
  <input type="text" id="origin" placeholder="תל חי 6 ראשון לציון" autocomplete="off">
  <label>יעד:</label>
  <input type="text" id="destination" placeholder="הראה 264 רמת גן" autocomplete="off">
  <label>שעת יציאה:</label>
  <input type="time" id="departureTime">

  <div id="returnSection" style="display: none;">
    <h3>נסיעה חזור</h3>
    <label>מוצא חזור:</label>
    <input type="text" id="returnOrigin" placeholder="הראה 264 רמת גן" autocomplete="off">
    <label>יעד חזור:</label>
    <input type="text" id="returnDestination" placeholder="תל חי 6 ראשון לציון" autocomplete="off">
    <label>שעת חזור:</label>
    <input type="time" id="returnTime">
  </div>

  <br>
  <button onclick="calculateTrip()">חשב</button>

  <h3>תוצאה:</h3>
  <div id="result"></div>

  <script>
    function toggleReturn() {
      const type = document.getElementById("tripType").value;
      document.getElementById("returnSection").style.display = (type === "roundtrip") ? "block" : "none";
    }

    function getRoute(origin, destination) {
      return new Promise((resolve, reject) => {
        const service = new google.maps.DirectionsService();
        service.route({
          origin: origin,
          destination: destination,
          travelMode: 'DRIVING'
        }, (result, status) => {
          if (status === 'OK') {
            const route = result.routes[0].legs[0];
            resolve({
              distance: route.distance.value,
              duration: route.duration.value
            });
          } else {
            reject('החישוב נכשל: ' + status);
          }
        });
      });
    }

    function formatMinutesToTime(minutes) {
      const hours = Math.floor(minutes / 60);
      const mins = minutes % 60;
      return `${hours > 0 ? hours + ' שעות ' : ''}${mins} דקות`;
    }

    async function calculateTrip() {
      const origin = document.getElementById("origin").value;
      const destination = document.getElementById("destination").value;
      const tripType = document.getElementById("tripType").value;
      const departureTime = document.getElementById("departureTime").value;
      const returnTime = document.getElementById("returnTime").value;

      const returnOrigin = document.getElementById("returnOrigin").value || destination;
      const returnDestination = document.getElementById("returnDestination").value || origin;

      document.getElementById("result").innerText = "מחשב...";

      try {
        let go = await getRoute(origin, destination);
        let totalDistance = go.distance;
        let totalDuration = go.duration;

        if (tripType === 'roundtrip') {
          let back = await getRoute(returnOrigin, returnDestination);
          totalDistance += back.distance;
          totalDuration += back.duration;
        }

        const km = (totalDistance / 1000).toFixed(1);
        const travelMinutes = Math.round(totalDuration / 60);
        const travelFormatted = formatMinutesToTime(travelMinutes);

        let totalTimeFormatted = '';
        if (tripType === 'roundtrip' && departureTime && returnTime) {
          const dep = new Date(`2000-01-01T${departureTime}:00`);
          const ret = new Date(`2000-01-01T${returnTime}:00`);
          const diffMinutes = (ret - dep) / (1000 * 60);
          totalTimeFormatted = formatMinutesToTime(diffMinutes);
        }

        document.getElementById("result").innerHTML =
          `ק״מ משוכלל: ${km} ק״מ<br>` +
          `זמן נסיעה כולל: ${travelFormatted}<br>` +
          (tripType === "roundtrip" ? `זמן כולל: ${totalTimeFormatted}` : "");
      } catch (err) {
        document.getElementById("result").innerText = err;
      }
    }

    // Improved Autocomplete with full place validation
    function initAutocomplete() {
      const inputs = ["origin", "destination", "returnOrigin", "returnDestination"];

      inputs.forEach(id => {
        const input = document.getElementById(id);
        if (input) {
          const autocomplete = new google.maps.places.Autocomplete(input, {
            types: ["geocode"],
            fields: ["place_id", "geometry", "formatted_address", "name"]
          });

          autocomplete.setComponentRestrictions({ country: ["il"] });

          autocomplete.addListener("place_changed", () => {
            const place = autocomplete.getPlace();
            console.log(`Selected for #${id}:`, place);
            if (!place.geometry) {
              alert(`לא ניתן למצוא מיקום עבור: ${input.value}`);
            }
          });
        }
      });
    }
  </script>

  <script async
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAasX9VHsRF10ps6XvhD26eaTLm-torj1I&libraries=places&callback=initAutocomplete">
  </script>
</body>
</html>